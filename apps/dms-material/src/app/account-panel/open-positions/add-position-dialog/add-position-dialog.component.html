<!-- eslint-disable @angular-eslint/template/cyclomatic-complexity -- Form validation requires nested conditionals -->
<h2 mat-dialog-title data-testid="dialog-title">Add New Position</h2>

<mat-dialog-content class="dialog-content">
  <form [formGroup]="form" class="form-grid">
    <div class="form-row">
      <div class="symbol-field-wrapper">
        <dms-symbol-autocomplete
          data-testid="symbol-autocomplete"
          [searchFn]="symbolSearchFnBound"
          [label]="'Symbol'"
          [placeholder]="'Search for a symbol...'"
          (symbolSelected)="onSymbolSelected($event)"
          (symbolBlurred)="onSymbolBlur()"
        ></dms-symbol-autocomplete>
        @if (symbolControl.invalid && (symbolControl.dirty ||
        symbolControl.touched)) { @if (symbolControl.errors?.['required']) {
        <div class="validation-error" data-testid="symbol-required-error">
          Symbol is required
        </div>
        } @if (symbolControl.errors?.['invalidSymbol']) {
        <div class="validation-error" data-testid="symbol-invalid-error">
          Symbol does not exist in universe
        </div>
        } }
      </div>

      <div class="field-wrapper">
        <mat-form-field appearance="outline">
          <mat-label>Quantity</mat-label>
          <input
            data-testid="quantity-input"
            matInput
            formControlName="quantity"
            placeholder="100"
            (input)="onQuantityInput($event)"
          />
        </mat-form-field>
        @if (quantityControl.invalid && (quantityControl.dirty ||
        quantityControl.touched)) { @if (quantityControl.errors?.['required']) {
        <div class="validation-error" data-testid="quantity-required-error">
          Quantity is required
        </div>
        } @if (quantityControl.errors?.['min']) {
        <div class="validation-error" data-testid="quantity-min-error">
          Quantity must be at least 1
        </div>
        } @if (quantityControl.errors?.['pattern']) {
        <div class="validation-error" data-testid="quantity-pattern-error">
          Quantity must be a whole number
        </div>
        } }
      </div>
    </div>

    <div class="form-row">
      <div class="field-wrapper">
        <mat-form-field appearance="outline">
          <mat-label>Price</mat-label>
          <input
            data-testid="price-input"
            matInput
            formControlName="price"
            placeholder="150.50"
            (input)="onPriceInput($event)"
          />
        </mat-form-field>
        @if (priceControl.invalid && (priceControl.dirty ||
        priceControl.touched)) { @if (priceControl.errors?.['required']) {
        <div class="validation-error" data-testid="price-required-error">
          Price is required
        </div>
        } @if (priceControl.errors?.['min']) {
        <div class="validation-error" data-testid="price-min-error">
          Price must be positive
        </div>
        } @if (priceControl.errors?.['pattern']) {
        <div class="validation-error" data-testid="price-pattern-error">
          Price must have 2-5 decimal places
        </div>
        } }
      </div>

      <div class="field-wrapper">
        <mat-form-field appearance="outline">
          <mat-label>Purchase Date</mat-label>
          <input
            data-testid="purchase-date-input"
            matInput
            [matDatepicker]="picker"
            formControlName="purchase_date"
            placeholder="MM/DD/YYYY"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="picker"
          ></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
        @if (purchaseDateControl.invalid && (purchaseDateControl.dirty ||
        purchaseDateControl.touched)) { @if
        (purchaseDateControl.errors?.['required']) {
        <div
          class="validation-error"
          data-testid="purchase-date-required-error"
        >
          Purchase date is required
        </div>
        } }
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions>
  <button data-testid="cancel-button" mat-button (click)="onCancel()">
    Cancel
  </button>
  <button
    data-testid="add-position-button"
    mat-raised-button
    color="primary"
    (click)="onSave()"
    [disabled]="!form.valid"
  >
    Add Position
  </button>
</mat-dialog-actions>
