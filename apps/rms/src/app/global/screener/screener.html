<p-toolbar class="text-lg font-semibold flex-none">
  <ng-template #start>
    <div class="whitespace-nowrap truncate">Screener</div>
  </ng-template>
  <ng-template #end>
    <p-button icon="pi pi-refresh" class="mr-2" text severity="secondary"
      pTooltip="Refresh" tooltipPosition="bottom" (click)="refresh()"/>
    
    <!-- Use Screener button - only visible when feature flag is enabled -->
    @if (isFeatureEnabled()) {
      <p-button 
        icon="pi pi-sync" 
        [loading]="isSyncing"
        [disabled]="isSyncing"
        class="mr-2" 
        severity="success"
        pTooltip="Use Screener to update Universe" 
        tooltipPosition="bottom" 
        (click)="syncFromScreener()">
        Use Screener
      </p-button>
    }
  </ng-template>
</p-toolbar>

<p-table [value]="filteredScreenerData$()"
  size="small"
  [scrollable]="true"
  class="flex-1 overflow-auto min-h-0"
  showGridlines
  [rowTrackBy]="trackById">
  <ng-template pTemplate="header">
    <tr>
      <th></th>
      <th>
        <p-select
          [options]="riskGroups"
          [(ngModel)]="selectedRiskGroup"
          placeholder="Select One"
          [showClear]="true"
          optionLabel="label"
          class="w-40"
        >
          <ng-template let-option #item>
            <p-tag [value]="option.value" />
          </ng-template>
        </p-select>
      </th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
    <tr>
      <th>Symbol</th>
      <th>Risk Group</th>
      <th>Has Volatility</th>
      <th>Objectives Understood</th>
      <th>Graph Higher Before 2008</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-row>
    <tr>
      <td><a
        [href]="'https://www.cefconnect.com/fund/' + row.symbol"
        target="_blank"
        class="underline text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
      >
        {{ row.symbol }}
      </a></td>
      <td>{{ row.risk_group }}</td>
      <td><p-checkbox binary="true" [ngModel]="row.has_volitility" (ngModelChange)="updateScreener(row.id, 'has_volitility', $event)"></p-checkbox></td>
      <td><p-checkbox binary="true" [ngModel]="row.objectives_understood" (ngModelChange)="updateScreener(row.id, 'objectives_understood', $event)"></p-checkbox></td>
      <td><p-checkbox binary="true" [ngModel]="row.graph_higher_before_2008" (ngModelChange)="updateScreener(row.id, 'graph_higher_before_2008', $event)"></p-checkbox></td>
    </tr>
  </ng-template>
</p-table>

<!-- Overlay -->
@if (showOverlay$()) {
  <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <div class="text-center">
      <p-progressSpinner
        styleClass="w-12 h-12"
        strokeWidth="4"
        fill="var(--surface-ground)"
        animationDuration=".5s">
      </p-progressSpinner>
      <p class="mt-4 text-white font-medium">Refreshing data...</p>
    </div>
  </div>
}

<!-- Toast for sync notifications -->
<p-toast></p-toast>
