<p-toolbar class="text-lg font-semibold flex-none">
  <ng-template #start>
    <div class="whitespace-nowrap truncate">Universe</div>
  </ng-template>
  <ng-template #end>
    <p-button (click)="settingsService.show()" icon="pi pi-cog" class="mr-2" text severity="secondary" pTooltip="Settings" tooltipPosition="bottom" />
  </ng-template>
</p-toolbar>
<p-table [value]="universe$()"
size="small"
[scrollable]="true" class="flex-1 overflow-auto min-h-0"
showGridlines
>
  <ng-template pTemplate="header">
    <tr>
      <th>
        <p-columnFilter field="symbol" [showMenu]="false">
        </p-columnFilter>
      </th>
      <th>
        <p-columnFilter field="riskGroup" matchMode="equals" [showMenu]="false">
          <ng-template #filter let-value let-filter="filterCallback">
            <p-select [options]="riskGroups" (onChange)="filter($event.value)" placeholder="Select One" [showClear]="true">
              <ng-template let-option #item>
                <p-tag [value]="option.value" />
              </ng-template>
            </p-select>
          </ng-template>
        </p-columnFilter>
      </th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th>
        <p-columnFilter field="expired" matchMode="equals" [showMenu]="false">
          <ng-template #filter let-value let-filter="filterCallback">
            <p-select [options]="expiredOptions" (onChange)="filter($event.value)" placeholder="Select One" [showClear]="true">
              <ng-template let-option #item>
                {{ option.label }}
              </ng-template>
            </p-select>
          </ng-template>
        </p-columnFilter>
      </th>
    </tr>
    <tr>
      <th>Symbol</th>
      <th>Risk Group</th>
      <th>Distribution</th>
      <th>Distributions per Year</th>
      <th pSortableColumn="yield_percent">Yield % <p-sortIcon field="yield_percent" /></th>
      <th>Last Price</th>
      <th>Ex-Date</th>
      <th pSortableColumn="most_recent_sell_date">Most Recent Sell Date <p-sortIcon field="most_recent_sell_date" /></th>
      <th>Expired</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-row>
    <tr [ngClass]="isDimmed(row) ? 'text-gray-400 dark:text-gray-600' : ''">
      <td>{{ row.symbol }}</td>
      <td>{{ row.riskGroup }}</td>
      <td [pEditableColumn]="'distribution'" class="bg-gray-200 dark:bg-gray-800">
        <p-cellEditor>
          <ng-template #input>
            <p-inputNumber mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="5" [(ngModel)]="row.distribution" [min]="0" [step]="0.01" (keydown.enter)="onEditCommit(row, 'distribution')" (keydown)="stopArrowKeyPropagation($event)" class="w-32 block"></p-inputNumber>
          </ng-template>
          <ng-template #output>
            {{ row.distribution }}
          </ng-template>
        </p-cellEditor>
      </td>
      <td [pEditableColumn]="'distributions_per_year'" class="bg-gray-200 dark:bg-gray-800">
        <p-cellEditor>
          <ng-template #input>
            <p-inputNumber [(ngModel)]="row.distributions_per_year" [min]="1" [max]="12" [step]="1" (keydown.enter)="onEditCommit(row, 'distributions_per_year')" (keydown)="stopArrowKeyPropagation($event)" class="w-32 block"></p-inputNumber>
          </ng-template>
          <ng-template #output>
            {{ row.distributions_per_year }}
          </ng-template>
        </p-cellEditor>
      </td>
      <td>{{ row.yield_percent | number:'1.2-2' }}%</td>
      <td>{{ row.last_price }}</td>
      @if (row.ex_date && row.ex_date >= today) {
        <td [pEditableColumn]="'ex_date'" class="bg-gray-300 dark:bg-gray-700">
          <p-cellEditor>
            <ng-template #input>
              <p-datepicker [(ngModel)]="row.ex_date" (onSelect)="onEditCommit(row, 'ex_date')" (keydown.enter)="onEditCommit(row, 'ex_date')" (keydown)="stopArrowKeyPropagation($event)" appendTo="body" class="w-32 block" dateFormat="mm/dd/yy"></p-datepicker>
            </ng-template>
            <ng-template #output>
              {{ row.ex_date | date:'MM/dd/yyyy' }}
            </ng-template>
          </p-cellEditor>
        </td>
      } @else {
        <td [pEditableColumn]="'ex_date'" class="bg-red-300 dark:bg-red-700">
          <p-cellEditor>
            <ng-template #input>
              <p-datepicker [(ngModel)]="row.ex_date" (onSelect)="onEditCommit(row, 'ex_date')" (keydown.enter)="onEditCommit(row, 'ex_date')" (keydown)="stopArrowKeyPropagation($event)" appendTo="body" class="w-32 block" dateFormat="mm/dd/yy"></p-datepicker>
            </ng-template>
            <ng-template #output>
              {{ row.ex_date | date:'MM/dd/yyyy' }}
            </ng-template>
          </p-cellEditor>
        </td>
      }
      <td>{{ row.most_recent_sell_date | date:'MM/dd/yyyy' }}</td>
      <td class="text-center">{{ row.expired ? '*' : '' }}</td>
    </tr>
  </ng-template>
</p-table>
